name: ci.rollback

on:
  workflow_dispatch:
    inputs:
      phase_from:
        description: "Start phase (e.g. 00)"
        required: true
        default: "00"
      phase_to:
        description: "End phase (e.g. 00)"
        required: true
        default: "00"

concurrency:
  group: infra-phase-serial
  cancel-in-progress: false

jobs:
  rollback:
    runs-on: ubuntu-latest
    container:
      image: willhallonline/ansible:2.18-alpine-3.22
    env:
      INFRA_SSH_HOST: ${{ secrets.INFRA_SSH_HOST }}
      INFRA_SSH_USER: ${{ secrets.INFRA_SSH_USER }}
      INFRA_SSH_PRIVATE_KEY: ${{ secrets.INFRA_SSH_PRIVATE_KEY }}
      ANSIBLE_HOST_KEY_CHECKING: "False"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          umask 077
          printf '%s\n' "$INFRA_SSH_PRIVATE_KEY" > /tmp/infra_ssh_key
          echo "ANSIBLE_PRIVATE_KEY_FILE=/tmp/infra_ssh_key" >> "$GITHUB_ENV"

      - name: Rollback
        run: |
          ansible-playbook -i inventory/hosts.ini playbooks/rollback.yml \
            -e phase_from="${{ inputs.phase_from }}" \
            -e phase_to="${{ inputs.phase_to }}"

      - name: Status (post-rollback)
        run: |
          ansible-playbook -i inventory/hosts.ini playbooks/status.yml \
            -e phase_target="${{ inputs.phase_from }}"
