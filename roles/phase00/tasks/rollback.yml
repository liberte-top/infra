---
- name: Stat phase00 facts file
  stat:
    path: /var/lib/infra/phase/00/facts.json
  register: phase00_facts_stat

- name: Read phase00 facts file
  when: phase00_facts_stat.stat.exists
  slurp:
    src: /var/lib/infra/phase/00/facts.json
  register: phase00_facts_raw

- name: Parse phase00 facts
  when: phase00_facts_raw is defined and phase00_facts_raw.content is defined
  set_fact:
    phase00_facts: "{{ phase00_facts_raw.content | b64decode | from_json }}"

- name: Determine packages to remove
  when: phase00_facts is defined
  set_fact:
    phase00_remove:
      "{{ phase00_facts.packages.desired | difference(phase00_facts.packages.pre_installed) }}"

- name: Remove packages installed by phase00
  when: phase00_remove is defined and phase00_remove | length > 0
  apt:
    name: "{{ phase00_remove }}"
    state: absent
    purge: false

- name: Remove phase00 facts file
  file:
    path: /var/lib/infra/phase/00/facts.json
    state: absent

- name: Remove phase00 phase dir (if empty)
  file:
    path: /var/lib/infra/phase/00
    state: absent
