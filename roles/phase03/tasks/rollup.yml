---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase03 state dir
  file:
    path: /var/lib/infra/phase/03
    state: directory
    mode: "0755"

- name: Read phase03 state file
  slurp:
    src: /var/lib/infra/phase/03/state.json
  register: phase03_state_raw
  ignore_errors: true

- name: Parse phase03 state
  when: phase03_state_raw is defined and phase03_state_raw.content is defined
  set_fact:
    phase03_state: "{{ phase03_state_raw.content | b64decode | from_json }}"

- name: Capture phase03 previous state
  when: phase03_state is defined
  set_fact:
    phase03_state_prev: "{{ phase03_state }}"

- name: Check k3s service status
  command: systemctl is-active k3s
  register: phase03_k3s_service
  changed_when: false
  failed_when: false
  when: phase03_state is defined

- name: Check k3s version
  command: /usr/local/bin/k3s --version
  register: phase03_k3s_version_check
  changed_when: false
  failed_when: false
  when: phase03_state is defined

- name: Check k3s node status
  command: /usr/local/bin/kubectl get nodes --request-timeout=5s
  register: phase03_k3s_nodes_check
  changed_when: false
  failed_when: false
  when: phase03_state is defined

- name: Check kubeconfig permissions
  stat:
    path: /etc/rancher/k3s/k3s.yaml
  register: phase03_kubeconfig_stat
  when: phase03_state is defined

- name: Compute phase03 state match
  when: phase03_state is defined
  set_fact:
    phase03_state_matches: >-
      {{
        (phase03_state.phase | default('')) == '03' and
        (phase03_state.k3s.version | default('')) == k3s_version_lock and
        (phase03_state.k3s.cni | default('')) == 'flannel' and
        (phase03_state.k3s.addons | default('')) == 'default' and
        (phase03_state.k3s.api_access | default('')) == 'ssh-only' and
        (phase03_state.k3s.etcd_snapshot_retention | default(1)) == (k3s_etcd_snapshot_retention | default(1))
      }}

- name: Compute phase03 k3s readiness
  when: phase03_state is defined
  set_fact:
    phase03_k3s_ok: >-
      {{
        (phase03_k3s_service.stdout | default('')) == 'active' and
        (phase03_k3s_version_check.stdout | default('')) is search(k3s_version_lock) and
        (phase03_k3s_nodes_check.rc | default(1)) == 0
      }}
    phase03_kubeconfig_ok: >-
      {{
        phase03_kubeconfig_stat is defined and
        phase03_kubeconfig_stat.stat is defined and
        (phase03_kubeconfig_stat.stat.exists | default(false)) and
        (phase03_kubeconfig_stat.stat.grp | default('')) == k3s_admin_user and
        (phase03_kubeconfig_stat.stat.mode | default('')) == '0640'
      }}

- name: Compute phase03 ready flag
  when: phase03_state is defined
  set_fact:
    phase03_ready: "{{ phase03_state_matches and phase03_k3s_ok and phase03_kubeconfig_ok }}"

- name: Compute phase03 skip flag
  when: phase03_state is defined
  set_fact:
    phase03_skip: "{{ phase03_ready }}"

- name: Skip phase03 rollup when already ready
  meta: end_role
  when: phase03_skip | default(false)

- name: Ensure br_netfilter module is loaded
  command: modprobe br_netfilter
  changed_when: false
  failed_when: false

- name: Install k3s sysctl settings
  copy:
    dest: /etc/sysctl.d/99-k3s.conf
    content: |-
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
    owner: root
    group: root
    mode: "0644"

- name: Apply sysctl settings
  command: sysctl --system
  register: phase03_sysctl_apply
  changed_when: false

- name: Check k3s binary
  stat:
    path: /usr/local/bin/k3s
  register: phase03_k3s_bin

- name: Read installed k3s version
  command: /usr/local/bin/k3s --version
  register: phase03_k3s_version_raw
  changed_when: false
  failed_when: false
  when: phase03_k3s_bin.stat.exists

- name: Parse installed k3s version
  set_fact:
    phase03_k3s_installed_version: "{{ phase03_k3s_version_raw.stdout | regex_search('v[0-9]+\\.[0-9]+\\.[0-9]+\\+k3s[0-9]+') }}"
  when: phase03_k3s_version_raw is defined and phase03_k3s_version_raw.stdout is defined

- name: Fetch k3s release channels
  uri:
    url: https://update.k3s.io/v1-release/channels
    return_content: true
  register: phase03_k3s_channels
  when: phase03_k3s_installed_version is not defined and k3s_version_lock in ['stable', 'latest']

- name: Resolve stable k3s version
  set_fact:
    phase03_k3s_stable_version: "{{ (phase03_k3s_channels.content | from_json).data | selectattr('id', 'eq', 'stable') | map(attribute='latest') | first }}"
  when: phase03_k3s_channels is defined and phase03_k3s_channels.content is defined

- name: Resolve desired k3s version
  set_fact:
    phase03_k3s_version_resolved: >-
      {{
        phase03_k3s_installed_version
        if (phase03_k3s_installed_version is defined and phase03_k3s_installed_version | length > 0)
        else (
          phase03_k3s_stable_version
          if (k3s_version_lock in ['stable', 'latest'])
          else k3s_version_lock
        )
      }}

- name: Install k3s server
  shell: |
    set -o pipefail
    timeout 900s sh -c 'curl -sfL https://get.k3s.io | \
      INSTALL_K3S_VERSION="{{ phase03_k3s_version_resolved }}" \
      INSTALL_K3S_EXEC="server --write-kubeconfig-mode 600 --etcd-snapshot-retention={{ k3s_etcd_snapshot_retention | default(1) }}" \
      sh -'
  args:
    executable: /bin/bash
    creates: /usr/local/bin/k3s
  when: phase03_k3s_version_resolved is defined and (phase03_k3s_installed_version | default('')) != phase03_k3s_version_resolved

- name: Ensure k3s service is enabled and started
  service:
    name: k3s
    state: started
    enabled: true

- name: Ensure kubeconfig is readable by admin group
  file:
    path: /etc/rancher/k3s/k3s.yaml
    owner: root
    group: "{{ k3s_admin_user }}"
    mode: "0640"

- name: Ensure admin kubeconfig directory
  file:
    path: "/home/{{ k3s_admin_user }}/.kube"
    state: directory
    owner: "{{ k3s_admin_user }}"
    group: "{{ k3s_admin_user }}"
    mode: "0700"

- name: Copy kubeconfig for admin user
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "/home/{{ k3s_admin_user }}/.kube/config"
    owner: "{{ k3s_admin_user }}"
    group: "{{ k3s_admin_user }}"
    mode: "0600"
    remote_src: true

- name: Check k3s node status
  command: /usr/local/bin/kubectl get nodes --request-timeout=20s
  register: phase03_k3s_nodes
  changed_when: false
  failed_when: false
  retries: 6
  delay: 10
  until: phase03_k3s_nodes.rc == 0

- name: Capture UTC timestamp
  command: date -u +%Y-%m-%dT%H:%M:%SZ
  register: phase03_now
  changed_when: false

- name: Build phase03 state
  set_fact:
    phase03_state:
      phase: "03"
      ok: true
      timestamp: "{{ phase03_now.stdout }}"
      k3s:
        version: "{{ phase03_k3s_version_resolved | default('unknown') }}"
        installed_version: "{{ phase03_k3s_installed_version | default('unknown') }}"
        api_access: "ssh-only"
        addons: "default"
        cni: "flannel"
        etcd_snapshot_retention: "{{ k3s_etcd_snapshot_retention | default(1) }}"
      kubeconfig:
        system_path: "/etc/rancher/k3s/k3s.yaml"
        system_group: "{{ k3s_admin_user }}"
        system_mode: "0640"
        path: "/home/{{ k3s_admin_user }}/.kube/config"

- name: Build phase03 state compare
  set_fact:
    phase03_state_compact:
      phase: "03"
      ok: true
      k3s:
        version: "{{ phase03_k3s_version_resolved | default('unknown') }}"
        installed_version: "{{ phase03_k3s_installed_version | default('unknown') }}"
        api_access: "ssh-only"
        addons: "default"
        cni: "flannel"
        etcd_snapshot_retention: "{{ k3s_etcd_snapshot_retention | default(1) }}"
      kubeconfig:
        system_path: "/etc/rancher/k3s/k3s.yaml"
        system_group: "{{ k3s_admin_user }}"
        system_mode: "0640"
        path: "/home/{{ k3s_admin_user }}/.kube/config"
    phase03_state_prev_compact: >-
      {{
        (phase03_state_prev | default({}))
        | dict2items
        | rejectattr('key', 'equalto', 'timestamp')
        | items2dict
      }}

- name: Check phase03 state change
  set_fact:
    phase03_state_changed: >-
      {{
        (phase03_state_prev is not defined) or
        (phase03_state_prev_compact != phase03_state_compact)
      }}

- name: Write phase03 state file
  copy:
    dest: /var/lib/infra/phase/03/state.json
    content: "{{ phase03_state | to_nice_json }}"
    mode: "0644"
  when: phase03_state_changed | default(true)
