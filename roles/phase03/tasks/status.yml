---
- name: Compute precheck readiness
  set_fact:
    phase03_pre_ready: "{{ (ansible_facts.os_family == 'Debian') and (ansible_facts['user_id'] == 'root') }}"

- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase03 state dir
  file:
    path: /var/lib/infra/phase/03
    state: directory
    mode: "0755"

- name: Stat phase03 facts file
  stat:
    path: /var/lib/infra/phase/03/facts.json
  register: phase03_facts_stat

- name: Read phase03 facts file
  slurp:
    src: /var/lib/infra/phase/03/facts.json
  register: phase03_facts_raw
  when: phase03_facts_stat.stat.exists

- name: Parse phase03 facts
  when: phase03_facts_raw is defined and phase03_facts_raw.content is defined
  set_fact:
    phase03_facts: "{{ phase03_facts_raw.content | b64decode | from_json }}"

- name: Capture k3s service status
  command: systemctl is-active k3s
  register: phase03_k3s_service
  changed_when: false
  failed_when: false

- name: Read k3s version
  command: /usr/local/bin/k3s --version
  register: phase03_k3s_version_raw
  changed_when: false
  failed_when: false

- name: Check API readiness
  command: /usr/local/bin/kubectl get --raw='/readyz' --request-timeout=5s
  register: phase03_k3s_readyz
  changed_when: false
  failed_when: false
  retries: 3
  delay: 5
  until: phase03_k3s_readyz.rc == 0

- name: Compute k3s readiness
  set_fact:
    phase03_k3s_ready: >-
      {{
        (phase03_k3s_service.stdout | default('')) == 'active'
        and (phase03_k3s_readyz.rc | default(1)) == 0
      }}

- name: Compute phase03 status value
  set_fact:
    phase03_status_value: >-
      {{
        'pre-not-ready' if not phase03_pre_ready
        else
        (
          'cur-success' if phase03_k3s_ready
          else
          (
            'cur-failed' if phase03_facts is defined
            else 'pre-ready'
          )
        )
      }}

- name: Set phase03 status
  set_fact:
    phase_status_map: "{{ (hostvars[inventory_hostname].phase_status_map | default({})) | combine({ phase_id: phase03_status_value }) }}"
