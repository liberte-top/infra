---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase05 facts dir
  file:
    path: /var/lib/infra/phase/05
    state: directory
    mode: "0755"

- name: Stat phase05 facts file
  stat:
    path: /var/lib/infra/phase/05/facts.json
  register: phase05_facts_stat

- name: Read phase05 facts file
  slurp:
    src: /var/lib/infra/phase/05/facts.json
  register: phase05_facts_raw
  when: phase05_facts_stat.stat.exists

- name: Parse phase05 facts
  when: phase05_facts_raw is defined and phase05_facts_raw.content is defined
  set_fact:
    phase05_facts_prev: "{{ phase05_facts_raw.content | b64decode | from_json }}"

- name: Normalize helm version
  set_fact:
    phase05_helm_version: >-
      {{
        (helm_version_lock | regex_search('^v'))
        | ternary(helm_version_lock, 'v' ~ helm_version_lock)
      }}

- name: Detect system architecture
  command: uname -m
  register: phase05_uname
  changed_when: false

- name: Map helm architecture
  set_fact:
    phase05_helm_arch: >-
      {{
        'amd64' if (phase05_uname.stdout | default('')) in ['x86_64', 'amd64'] else
        'arm64' if (phase05_uname.stdout | default('')) in ['aarch64', 'arm64'] else
        (phase05_uname.stdout | default('amd64'))
      }}

- name: Check helm binary
  stat:
    path: /usr/local/bin/helm
  register: phase05_helm_bin

- name: Read helm version
  command: /usr/local/bin/helm version --short
  register: phase05_helm_version_raw
  changed_when: false
  failed_when: false
  when: phase05_helm_bin.stat.exists

- name: Compute helm version match
  set_fact:
    phase05_helm_version_ok: >-
      {{
        phase05_helm_version_raw is defined and
        (phase05_helm_version_raw.stdout | default('')) is search(phase05_helm_version)
      }}

- name: Compute phase05 readiness
  set_fact:
    phase05_ready: >-
      {{
        (phase05_helm_version_ok | default(false))
      }}
  when: phase05_facts_prev is defined

- name: Compute phase05 state match
  set_fact:
    phase05_state_matches: >-
      {{
        (phase05_facts_prev.phase | default('')) == '05' and
        (phase05_facts_prev.helm.version | default('')) == phase05_helm_version and
        (phase05_facts_prev.helm.path | default('')) == '/usr/local/bin/helm'
      }}
  when: phase05_facts_prev is defined

- name: Compute phase05 skip flag
  set_fact:
    phase05_skip: >-
      {{
        (phase05_facts_prev is defined) and
        (phase05_state_matches | default(false)) and
        (phase05_ready | default(false))
      }}

- name: Skip phase05 rollup when already ready
  debug:
    msg: "phase05 already converged; skip apply path"
  when: phase05_skip | default(false)
