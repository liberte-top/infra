---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase02 state dir
  file:
    path: /var/lib/infra/phase/02
    state: directory
    mode: "0755"

- name: Configure UFW IPv6 setting
  lineinfile:
    path: /etc/default/ufw
    regexp: '^IPV6='
    line: "IPV6={{ 'yes' if ufw_ipv6_enabled else 'no' }}"
    create: false

- name: Reset UFW rules
  command: ufw --force reset
  register: phase02_ufw_reset
  changed_when: true

- name: Set UFW default incoming policy
  ufw:
    direction: incoming
    policy: deny

- name: Set UFW default outgoing policy
  ufw:
    direction: outgoing
    policy: allow

- name: Set UFW default routed policy
  ufw:
    direction: routed
    policy: deny

- name: Allow UFW ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ ufw_allow_ports | difference(ufw_limit_ports | default([])) }}"

- name: Rate limit UFW ports
  ufw:
    rule: limit
    port: "{{ item }}"
    proto: tcp
  loop: "{{ ufw_limit_ports | default([]) }}"

- name: Configure UFW logging
  ufw:
    logging: "{{ ufw_logging }}"

- name: Enable UFW
  ufw:
    state: enabled

- name: Install sysctl hardening config
  template:
    src: sysctl.conf.j2
    dest: /etc/sysctl.d/99-liberte.conf
    owner: root
    group: root
    mode: "0644"

- name: Apply sysctl settings
  command: sysctl --system
  register: phase02_sysctl_apply
  changed_when: false

- name: Capture UTC timestamp
  command: date -u +%Y-%m-%dT%H:%M:%SZ
  register: phase02_now
  changed_when: false

- name: Build phase02 state
  set_fact:
    phase02_state:
      phase: "02"
      ok: true
      timestamp: "{{ phase02_now.stdout }}"
      ufw:
        allow_ports: "{{ ufw_allow_ports }}"
        limit_ports: "{{ ufw_limit_ports | default([]) }}"
        logging: "{{ ufw_logging }}"
        ipv6_enabled: "{{ ufw_ipv6_enabled }}"
      sysctl: "{{ liberte_sysctl }}"

- name: Write phase02 state file
  copy:
    dest: /var/lib/infra/phase/02/state.json
    content: "{{ phase02_state | to_nice_json }}"
    mode: "0644"
