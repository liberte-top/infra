---
- name: Remove admin authorized key
  authorized_key:
    user: "{{ k3s_admin_user }}"
    key: "{{ k3s_admin_pubkey }}"
    state: absent
  ignore_errors: true

- name: Remove admin sudoers
  file:
    path: "/etc/sudoers.d/90-{{ k3s_admin_user }}"
    state: absent

- name: Remove admin user
  user:
    name: "{{ k3s_admin_user }}"
    state: absent
    remove: true

- name: Remove sshd hardening drop-in
  file:
    path: /etc/ssh/sshd_config.d/99-liberte.conf
    state: absent

- name: Read phase01 state file
  slurp:
    src: /var/lib/infra/phase/01/state.json
  register: phase01_state_raw
  ignore_errors: true

- name: Parse phase01 state
  when: phase01_state_raw is defined and phase01_state_raw.content is defined
  set_fact:
    phase01_state: "{{ phase01_state_raw.content | b64decode | from_json }}"

- name: Check bootstrap backup presence
  stat:
    path: /var/lib/infra/phase/01/bootstrap.conf.bak
  register: phase01_bootstrap_backup

- name: Restore bootstrap sshd config
  when: phase01_state is defined and phase01_state.bootstrap is defined and phase01_state.bootstrap.original_path is defined and phase01_state.bootstrap.original_path != '' and phase01_bootstrap_backup.stat.exists
  copy:
    src: /var/lib/infra/phase/01/bootstrap.conf.bak
    dest: "{{ phase01_state.bootstrap.original_path }}"
    remote_src: true
    owner: root
    group: root
    mode: "0644"

- name: Validate sshd config
  command: sshd -t
  changed_when: false

- name: Reload ssh service
  service:
    name: ssh
    state: reloaded

- name: Remove phase01 state file
  file:
    path: /var/lib/infra/phase/01/state.json
    state: absent

- name: Remove phase01 status file
  file:
    path: /var/lib/infra/phase/01/status.json
    state: absent

- name: Remove bootstrap backup file
  file:
    path: /var/lib/infra/phase/01/bootstrap.conf.bak
    state: absent

- name: Remove phase01 state dir (if empty)
  file:
    path: /var/lib/infra/phase/01
    state: absent
