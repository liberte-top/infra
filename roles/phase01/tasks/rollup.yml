---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase01 state dir
  file:
    path: /var/lib/infra/phase/01
    state: directory
    mode: "0755"

- name: Ensure admin user
  user:
    name: "{{ k3s_admin_user }}"
    groups: sudo
    append: true
    create_home: true
    shell: /bin/bash

- name: Ensure root ssh directory
  file:
    path: /root/.ssh
    state: directory
    mode: "0700"

- name: Ensure admin ssh directory
  file:
    path: "/home/{{ k3s_admin_user }}/.ssh"
    state: directory
    mode: "0700"
    owner: "{{ k3s_admin_user }}"
    group: "{{ k3s_admin_user }}"

- name: Install admin authorized key
  authorized_key:
    user: "{{ k3s_admin_user }}"
    key: "{{ k3s_admin_pubkey }}"
    state: present

- name: Configure admin sudoers
  copy:
    dest: "/etc/sudoers.d/90-{{ k3s_admin_user }}"
    content: "{{ k3s_admin_user }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"

- name: Ensure sshd config drop-in dir
  file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: "0755"

- name: Check bootstrap sshd config (99-bootstrap)
  stat:
    path: /etc/ssh/sshd_config.d/99-bootstrap.conf
  register: phase01_bootstrap_99

- name: Require bootstrap sshd config (99-bootstrap)
  assert:
    that:
      - phase01_bootstrap_99.stat.exists
    fail_msg: "Missing required /etc/ssh/sshd_config.d/99-bootstrap.conf"

- name: Select bootstrap config path
  set_fact:
    phase01_bootstrap_path: /etc/ssh/sshd_config.d/99-bootstrap.conf

- name: Slurp bootstrap sshd config
  when: phase01_bootstrap_path != ''
  slurp:
    src: "{{ phase01_bootstrap_path }}"
  register: phase01_bootstrap_raw

- name: Backup bootstrap sshd config
  when: phase01_bootstrap_raw is defined and phase01_bootstrap_raw.content is defined
  copy:
    dest: /var/lib/infra/phase/01/bootstrap.conf.bak
    content: "{{ phase01_bootstrap_raw.content | b64decode }}"
    mode: "0644"

- name: Remove bootstrap sshd config to avoid overlap
  when: phase01_bootstrap_path != ''
  file:
    path: "{{ phase01_bootstrap_path }}"
    state: absent

- name: Install sshd hardening drop-in
  copy:
    dest: /etc/ssh/sshd_config.d/99-liberte.conf
    content: |-
      PermitRootLogin prohibit-password
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      KbdInteractiveAuthentication no
      PubkeyAuthentication yes
      AllowUsers {{ ssh_allow_users | join(' ') }}
    owner: root
    group: root
    mode: "0644"

- name: Validate sshd config
  command: sshd -t
  changed_when: false

- name: Reload ssh service
  service:
    name: ssh
    state: reloaded

- name: Capture UTC timestamp
  command: date -u +%Y-%m-%dT%H:%M:%SZ
  register: phase01_now
  changed_when: false

- name: Build phase01 state
  set_fact:
    phase01_state:
      phase: "01"
      ok: true
      timestamp: "{{ phase01_now.stdout }}"
      users:
        admin_user: "{{ k3s_admin_user }}"
        admin_pubkey: "{{ k3s_admin_pubkey }}"
      ssh:
        allow_users: "{{ ssh_allow_users }}"
      bootstrap:
        original_path: "{{ phase01_bootstrap_path }}"
        backed_up: "{{ phase01_bootstrap_path != '' }}"

- name: Write phase01 state file
  copy:
    dest: /var/lib/infra/phase/01/state.json
    content: "{{ phase01_state | to_nice_json }}"
    mode: "0644"
