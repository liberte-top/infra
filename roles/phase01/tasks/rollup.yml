---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase01 state dir
  file:
    path: /var/lib/infra/phase/01
    state: directory
    mode: "0755"

- name: Ensure admin user
  user:
    name: "{{ k3s_admin_user }}"
    groups: sudo
    append: true
    create_home: true
    shell: /bin/bash

- name: Ensure root ssh directory
  file:
    path: /root/.ssh
    state: directory
    mode: "0700"

- name: Ensure admin ssh directory
  file:
    path: "/home/{{ k3s_admin_user }}/.ssh"
    state: directory
    mode: "0700"
    owner: "{{ k3s_admin_user }}"
    group: "{{ k3s_admin_user }}"

- name: Install admin authorized key
  authorized_key:
    user: "{{ k3s_admin_user }}"
    key: "{{ k3s_admin_pubkey }}"
    state: present

- name: Configure admin sudoers
  copy:
    dest: "/etc/sudoers.d/90-{{ k3s_admin_user }}"
    content: "{{ k3s_admin_user }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"

- name: Ensure sshd config drop-in dir
  file:
    path: /etc/ssh/sshd_config.d
    state: directory
    mode: "0755"

- name: Ensure sshd base config (bootstrap baseline)
  blockinfile:
    path: /etc/ssh/sshd_config
    marker: "# {mark} LIBERTE BOOTSTRAP"
    block: |-
      PubkeyAuthentication yes
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      AllowUsers root
      PasswordAuthentication yes

- name: Install sshd hardening drop-in
  copy:
    dest: /etc/ssh/sshd_config.d/99-liberte.conf
    content: |-
      PermitRootLogin without-password
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      KbdInteractiveAuthentication no
      PubkeyAuthentication yes
      AllowUsers {{ ssh_allow_users | join(' ') }}
    owner: root
    group: root
    mode: "0644"

- name: Validate sshd config
  command: sshd -t
  changed_when: false

- name: Reload ssh service
  service:
    name: ssh
    state: reloaded

- name: Capture UTC timestamp
  command: date -u +%Y-%m-%dT%H:%M:%SZ
  register: phase01_now
  changed_when: false

- name: Build phase01 state
  set_fact:
    phase01_state:
      phase: "01"
      ok: true
      timestamp: "{{ phase01_now.stdout }}"
      users:
        admin_user: "{{ k3s_admin_user }}"
        admin_pubkey: "{{ k3s_admin_pubkey }}"
      ssh:
        allow_users: "{{ ssh_allow_users }}"

- name: Write phase01 state file
  copy:
    dest: /var/lib/infra/phase/01/state.json
    content: "{{ phase01_state | to_nice_json }}"
    mode: "0644"
