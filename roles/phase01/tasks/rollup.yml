---
- name: Ensure infra phase base dir
  file:
    path: /var/lib/infra/phase
    state: directory
    mode: "0755"

- name: Ensure phase01 facts dir
  file:
    path: /var/lib/infra/phase/01
    state: directory
    mode: "0755"

- name: Stat phase01 facts file
  stat:
    path: /var/lib/infra/phase/01/facts.json
  register: phase01_facts_stat

- name: Read phase01 facts file
  when: phase01_facts_stat.stat.exists
  slurp:
    src: /var/lib/infra/phase/01/facts.json
  register: phase01_facts_raw

- name: Parse phase01 facts
  when: phase01_facts_raw is defined and phase01_facts_raw.content is defined
  set_fact:
    phase01_facts: "{{ phase01_facts_raw.content | b64decode | from_json }}"

- name: Slurp root authorized_keys
  slurp:
    src: /root/.ssh/authorized_keys
  register: phase01_root_keys
  ignore_errors: true

- name: Check effective sshd settings
  command: "sshd -T -C user=root"
  register: phase01_sshd_effective
  changed_when: false
  failed_when: false
- name: Compute phase01 readiness
  set_fact:
    phase01_root_key_present: >-
      {{
        phase01_root_keys is defined and phase01_root_keys.content is defined and
        (phase01_root_keys.content | b64decode).find(root_pubkey) != -1
      }}
    phase01_sshd_ok: >-
      {{
        phase01_sshd_effective.stdout is defined and
        (
          ('permitrootlogin prohibit-password' in phase01_sshd_effective.stdout) or
          ('permitrootlogin without-password' in phase01_sshd_effective.stdout)
        ) and
        ('passwordauthentication no' in phase01_sshd_effective.stdout) and
        ('kbdinteractiveauthentication no' in phase01_sshd_effective.stdout) and
        ('pubkeyauthentication yes' in phase01_sshd_effective.stdout) and
        ('allowusers root' in phase01_sshd_effective.stdout)
      }}
    phase01_facts_match: >-
      {{
        phase01_facts is defined and
        (phase01_facts.phase | default('')) == '01' and
        (phase01_facts.users.root_pubkey | default('')) == root_pubkey and
        (phase01_facts.ssh.allow_users | default([])) == ['root']
      }}

- name: Compute phase01 ready flag
  set_fact:
    phase01_ready: "{{ phase01_facts_match and phase01_root_key_present and phase01_sshd_ok }}"

- name: Apply phase01 desired state when not ready
  when: not (phase01_ready | default(false))
  block:
    - name: Ensure root ssh directory
      file:
        path: /root/.ssh
        state: directory
        mode: "0700"

    - name: Install root authorized key
      authorized_key:
        user: root
        key: "{{ root_pubkey }}"
        state: present

    - name: Ensure sshd config drop-in dir
      file:
        path: /etc/ssh/sshd_config.d
        state: directory
        mode: "0755"

    - name: Ensure sshd base config (bootstrap baseline)
      blockinfile:
        path: /etc/ssh/sshd_config
        marker: "# {mark} LIBERTE BOOTSTRAP"
        block: |-
          PubkeyAuthentication yes
          KbdInteractiveAuthentication no
          ChallengeResponseAuthentication no
          AllowUsers root
          PasswordAuthentication yes

    - name: Install sshd hardening drop-in
      copy:
        dest: /etc/ssh/sshd_config.d/99-liberte.conf
        content: |-
          PermitRootLogin without-password
          PasswordAuthentication no
          ChallengeResponseAuthentication no
          KbdInteractiveAuthentication no
          PubkeyAuthentication yes
          AllowUsers root
        owner: root
        group: root
        mode: "0644"

    - name: Validate sshd config
      command: sshd -t
      changed_when: false

    - name: Reload ssh service
      service:
        name: ssh
        state: reloaded

    - name: Capture UTC timestamp
      command: date -u +%Y-%m-%dT%H:%M:%SZ
      register: phase01_now
      changed_when: false

    - name: Build phase01 facts
      set_fact:
        phase01_facts:
          phase: "01"
          ok: true
          timestamp: "{{ phase01_now.stdout }}"
          users:
            root_pubkey: "{{ root_pubkey }}"
          ssh:
            allow_users:
              - root

    - name: Write phase01 facts file
      copy:
        dest: /var/lib/infra/phase/01/facts.json
        content: "{{ phase01_facts | to_nice_json }}"
        mode: "0644"
