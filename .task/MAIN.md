# Task: 简化 infra 层代码

- **Branch:** feat/simplify-infra-layer
- **Status:** Active
- **Last-Sync:** 2026-02-25T05:24:22Z (on ZQXY123deMacBook-Pro.local)
- **Current Context:** 会话交接已准备完毕；下一会话从 phase02 依赖修复（community.general）继续推进。

## Phase Stack
> Current execution depth (Top is active)
  - 1.1: Baseline Snapshot & Simplification Scope

## Timeline
- [2026-02-25T03:37:46Z] INITIALIZED: Task started on ZQXY123deMacBook-Pro.local.
- [2026-02-25T03:37:46Z] PHASE PUSH: Begin Phase 1.1 (baseline snapshot + simplification scope alignment).
- [2026-02-25T03:48:43Z] UPDATE: Initialized .env from Host zhaoxi (host/user/key) and ran SSH smoke test successfully.
- [2026-02-25T03:55:48Z] UPDATE: Refactored scripts/ansible.sh to simplify flow and validated ansible/ansible-playbook dispatch paths.
- [2026-02-25T03:59:06Z] UPDATE: Removed dynamic TTY detection; keep fixed -it only for no-arg shell and regular execution path without -t.
- [2026-02-25T04:03:44Z] UPDATE: Switched no-arg behavior to ansible --version fallback and aligned AGENTS.md behavior docs.
- [2026-02-25T04:33:39Z] UPDATE: Removed command prediction in ansible.sh, switched to direct passthrough, and updated AGENTS.md examples to explicit ansible-playbook usage.
- [2026-02-25T04:38:58Z] UPDATE: Extracted default-args normalization into scripts/utils.sh (normalize_args) and wired ansible.sh to use it.
- [2026-02-25T04:40:02Z] UPDATE: Applied the same simplification to scripts/ssh.sh using normalize_args and require_command ssh.
- [2026-02-25T04:41:48Z] UPDATE: Extracted temporary SSH key file generation into shared utils function and reused it in ansible.sh/ssh.sh.
- [2026-02-25T04:47:37Z] UPDATE: Performed read-only server status audit (phase_target=05) and collected on-host phase files to verify real progress.
- [2026-02-25T04:54:58Z] UPDATE: Ran deployment verification (rollup 00->02 + status 02). Phase01 reached cur-success; phase02 blocked by missing ansible collection for ufw module.
- [2026-02-25T04:59:16Z] UPDATE: Confirmed root cause by inspecting phase02 tasks and ansible-galaxy collections list; community.general is missing from current execution image.
- [2026-02-25T05:12:04Z] UPDATE: Researched and tested common EE images; none provided community.general out-of-box in this environment.
- [2026-02-25T05:16:34Z] UPDATE: Cleaned local redundant docker images via image prune and captured before/after disk usage.
- [2026-02-25T05:18:13Z] UPDATE: Audited docker build cache state (builder du/verbose) and prepared selective prune strategy.
- [2026-02-25T05:24:22Z] UPDATE: Prepared handoff context for next session; next focus is phase02 dependency fix and redeploy validation.

## Global References
- **Docs:** .task/MAIN.md
- **Scripts:** scripts/ansible.sh
- **Assets:** .task/resources/STRUCTURE_SNAPSHOT.txt
---
*Generated by .task Convention - Synchronized via Git*
