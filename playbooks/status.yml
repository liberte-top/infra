---
- name: Status phases
  hosts: infra
  gather_facts: false
  become: true
  vars:
    ansible_host: "{{ lookup('env', 'INFRA_HOST') }}"
    ansible_user: "{{ lookup('env', 'INFRA_USER') | default('root', true) }}"
    ansible_password: "{{ lookup('env', 'INFRA_PASSWORD') }}"
    phase_order: ["00", "01"]
  pre_tasks:
    - name: Collect minimal facts
      setup:
        gather_subset:
          - min
    - name: Validate phase_target
      assert:
        that:
          - phase_target in phase_order
        fail_msg: "phase_target must be in phase_order"
    - name: Resolve phase index
      set_fact:
        phase_target_idx: "{{ phase_order.index(phase_target) | int }}"
  tasks:
    - name: Status phases up to target
      include_tasks: "phases/phase_{{ item }}.yml"
      vars:
        phase_id: "{{ item }}"
        phase_mode: "status"
      loop: "{{ phase_order }}"
      loop_control:
        index_var: phase_idx
      when: phase_idx <= phase_target_idx
    - name: Output phase status
      debug:
        msg: "phase={{ item.key }} status={{ item.value }}"
      loop: "{{ (phase_status_map | default({})) | dict2items }}"
